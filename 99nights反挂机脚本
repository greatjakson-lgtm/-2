-- Roblox 99夜服务器防挂机脚本
-- 放置在一个LocalScript中

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
if not localPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    localPlayer = Players.LocalPlayer
end

-- 防挂机功能
local antiAfk = {}
antiAfk.__index = antiAfk

function antiAfk.new()
    local self = setmetatable({}, antiAfk)
    self.connections = {}
    self.lastMovementTime = tick()
    self.isEnabled = true
    
    return self
end

function antiAfk:enable()
    if not self.isEnabled then
        self.isEnabled = true
        self:setupConnections()
        print("防挂机功能已启用")
    end
end

function antiAfk:disable()
    if self.isEnabled then
        self.isEnabled = false
        self:disconnectAll()
        print("防挂机功能已禁用")
    end
end

function antiAfk:setupConnections()
    -- 监听玩家输入
    table.insert(self.connections, UserInputService.InputBegan:Connect(function(input)
        self.lastMovementTime = tick()
    end))
    
    -- 监听角色移动
    table.insert(self.connections, RunService.Heartbeat:Connect(function()
        if not self.isEnabled then return end
        
        local character = localPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                self.lastMovementTime = tick()
            end
        end
    end))
    
    -- 定期模拟活动
    table.insert(self.connections, RunService.Heartbeat:Connect(function()
        if not self.isEnabled then return end
        
        local currentTime = tick()
        -- 如果超过15秒没有活动，模拟一次按键
        if currentTime - self.lastMovementTime > 15 then
            self:simulateActivity()
            self.lastMovementTime = currentTime
        end
    end))
end

function antiAfk:simulateActivity()
    -- 轻微移动鼠标（不会影响游戏体验）
    local mouse = localPlayer:GetMouse()
    mousemoverel(1, 0)
    wait(0.05)
    mousemoverel(-1, 0)
    
    -- 或者发送一个轻微的移动指令
    local character = localPlayer.Character
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid:Move(Vector3.new(0, 0, 0))
        end
    end
    
    print("模拟活动防止被踢出 - " .. os.date("%X"))
end

function antiAfk:disconnectAll()
    for _, connection in ipairs(self.connections) do
        connection:Disconnect()
    end
    self.connections = {}
end

-- 初始化防挂机系统
local afkPreventer = antiAfk.new()
afkPreventer:enable()

-- 创建一个简单的UI来开关功能
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AntiAfkGui"
ScreenGui.Parent = game:GetService("CoreGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 200, 0, 100)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Title.Text = "99夜防挂机工具"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Parent = Frame

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0.8, 0, 0, 30)
ToggleButton.Position = UDim2.new(0.1, 0, 0.4, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ToggleButton.Text = "禁用防挂机"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Parent = Frame

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, 0, 0, 20)
Status.Position = UDim2.new(0, 0, 0.8, 0)
Status.BackgroundTransparency = 1
Status.Text = "状态: 已启用"
Status.TextColor3 = Color3.fromRGB(0, 255, 0)
Status.Parent = Frame

ToggleButton.MouseButton1Click:Connect(function()
    if afkPreventer.isEnabled then
        afkPreventer:disable()
        ToggleButton.Text = "启用防挂机"
        Status.Text = "状态: 已禁用"
        Status.TextColor3 = Color3.fromRGB(255, 0, 0)
    else
        afkPreventer:enable()
        ToggleButton.Text = "禁用防挂机"
        Status.Text = "状态: 已启用"
        Status.TextColor3 = Color3.fromRGB(0, 255, 0)
    end
end)

-- 脚本结束时清理
localPlayer:GetPropertyChangedSignal("Character"):Connect(function()
    if not localPlayer.Character then
        afkPreventer:disable()
    else
        afkPreventer:enable()
    end
end)

game:GetService("UserInputService").WindowFocused:Connect(function()
    afkPreventer.lastMovementTime = tick()
end)

print("99夜防挂机脚本已加载！")
